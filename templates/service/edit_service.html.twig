{% extends 'layout/app.html.twig' %}

{% block title %}Informaci√≥n del Servicio{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }
        .form-group .form-error {
            color: #EF4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .tab-link.active {
            border-bottom-color: #3B82F6;
            color: #3B82F6;
        }
        #add-user-modal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" data-controller="service-form" data-service-id="{{ service.id }}">
    <h1 class="text-4xl font-bold mb-8 text-gray-900">Informaci√≥n del Servicio</h1>

    <div class="mb-8 border-b border-gray-200">
        <nav class="flex space-x-8" aria-label="Tabs">
            <a href="#" class="tab-link active font-medium text-lg text-gray-500 hover:text-blue-600 border-b-2 border-transparent pb-3" data-service-form-target="tabLink" data-action="click->service-form#switchTab" data-target="datos-basicos">
                <span class="mr-2">üìù</span> Datos B√°sicos
            </a>
            <a href="#" class="tab-link font-medium text-lg text-gray-500 hover:text-blue-600 border-b-2 border-transparent pb-3" data-service-form-target="tabLink" data-action="click->service-form#switchTab" data-target="asistencias">
                <span class="mr-2">üë•</span> Confirmaci√≥n de Asistencia
            </a>
            <a href="#" class="tab-link font-medium text-lg text-gray-500 hover:text-blue-600 border-b-2 border-transparent pb-3" data-service-form-target="tabLink" data-action="click->service-form#switchTab" data-target="vehiculos">
                <span class="mr-2">üöë</span> Veh√≠culos
            </a>
        </nav>
    </div>

    <div id="datos-basicos" class="tab-content-panel" data-service-form-target="tabContent">
        <div class="bg-white shadow-xl rounded-2xl p-8">
            {{ form_start(form, {'attr': {'class': 'space-y-10'}}) }}

            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                <div class="form-group">
                    {{ form_label(form.numeration, 'Numeraci√≥n') }}
                    {{ form_widget(form.numeration) }}
                    <div class="form-error">{{ form_errors(form.numeration) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.title, 'T√≠tulo') }}
                    {{ form_widget(form.title) }}
                    <div class="form-error">{{ form_errors(form.title) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.locality, 'Lugar') }}
                    {{ form_widget(form.locality) }}
                    <div class="form-error">{{ form_errors(form.locality) }}</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-x-8 gap-y-6">
                <div class="form-group">
                    {{ form_label(form.startDate, 'Inicio') }}
                    {{ form_widget(form.startDate) }}
                    <div class="form-error">{{ form_errors(form.startDate) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.timeAtBase, 'Base') }}
                    {{ form_widget(form.timeAtBase) }}
                    <div class="form-error">{{ form_errors(form.timeAtBase) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.departureTime, 'Salida') }}
                    {{ form_widget(form.departureTime) }}
                    <div class="form-error">{{ form_errors(form.departureTime) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.endDate, 'Fin') }}
                    {{ form_widget(form.endDate) }}
                    <div class="form-error">{{ form_errors(form.endDate) }}</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-x-8 gap-y-6">
                <div class="form-group">
                    {{ form_label(form.registrationLimitDate, 'L√≠mite') }}
                    {{ form_widget(form.registrationLimitDate) }}
                    <div class="form-error">{{ form_errors(form.registrationLimitDate) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.maxAttendees, 'Asistentes') }}
                    {{ form_widget(form.maxAttendees) }}
                    <div class="form-error">{{ form_errors(form.maxAttendees) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.type, 'Tipo') }}
                    {{ form_widget(form.type) }}
                    <div class="form-error">{{ form_errors(form.type) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.category, 'Categor√≠a') }}
                    {{ form_widget(form.category) }}
                    <div class="form-error">{{ form_errors(form.category) }}</div>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-6 border-b-2 border-gray-200 pb-3">Recursos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Ambulancia üöë</h4>
                        <div class="space-y-4">
                            <div class="form-group">
                                {{ form_label(form.numSvb, 'SVB') }}
                                {{ form_widget(form.numSvb) }}
                                <div class="form-error">{{ form_errors(form.numSvb) }}</div>
                            </div>
                            <div class="form-group">
                                {{ form_label(form.numSva, 'SVA') }}
                                {{ form_widget(form.numSva) }}
                                <div class="form-error">{{ form_errors(form.numSva) }}</div>
                            </div>
                            <div class="form-group">
                                {{ form_label(form.numSvae, 'SVAE') }}
                                {{ form_widget(form.numSvae) }}
                                <div class="form-error">{{ form_errors(form.numSvae) }}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-semibold mb-4">Personal Sanitario ü•ºü©∫</h4>
                        <div class="space-y-4">
                            <div class="form-group">
                                {{ form_label(form.numDoctors, 'Medico') }}
                                {{ form_widget(form.numDoctors) }}
                                <div class="form-error">{{ form_errors(form.numDoctors) }}</div>
                            </div>
                            <div class="form-group">
                                {{ form_label(form.numDues, 'Enfermeria') }}
                                <div class="grid grid-cols-2 gap-4">
                                    {{ form_widget(form.numDues, {'attr': {'placeholder': 'DUE'}}) }}
                                    {{ form_widget(form.numTecnicos, {'attr': {'placeholder': 'T√©cnicos'}}) }}
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-error">{{ form_errors(form.numDues) }}</div>
                                    <div class="form-error">{{ form_errors(form.numTecnicos) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-semibold mb-4">Otros</h4>
                        <div class="space-y-4">
                            <div class="form-group">
                                {{ form_label(form.afluencia, 'Afluencia üìà') }}
                                {{ form_widget(form.afluencia) }}
                                <div class="form-error">{{ form_errors(form.afluencia) }}</div>
                            </div>
                            <div class="flex items-center pt-3">
                                {{ form_widget(form.hasFieldHospital) }}
                                {{ form_label(form.hasFieldHospital, 'Hospital de Campa√±a üè•', {'label_attr': {'class': 'ml-3'}}) }}
                                <div class="form-error">{{ form_errors(form.hasFieldHospital) }}</div>
                            </div>
                            <div class="flex items-center">
                                {{ form_widget(form.hasProvisions) }}
                                {{ form_label(form.hasProvisions, 'Avituallamiento ü•™', {'label_attr': {'class': 'ml-3'}}) }}
                                <div class="form-error">{{ form_errors(form.hasProvisions) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-10">
                <div class="form-group">
                    {{ form_label(form.tasks, 'Tareas üìù') }}
                    <div data-service-form-target="quillTasks" style="height: 300px;"></div>
                    {{ form_widget(form.tasks, {'id': 'service_tasks', 'attr': {'style': 'display:none;', 'data-service-form-target': 'tasks'}}) }}
                    <div class="form-error">{{ form_errors(form.tasks) }}</div>
                </div>
                <div class="form-group">
                    {{ form_label(form.description, 'Descripci√≥n ‚ÑπÔ∏è') }}
                    <div data-service-form-target="quillDescription" style="height: 300px;"></div>
                    {{ form_widget(form.description, {'id': 'service_description', 'attr': {'style': 'display:none;', 'data-service-form-target': 'description'}}) }}
                    <div class="form-error">{{ form_errors(form.description) }}</div>
                </div>
            </div>

            <div style="display:none;">
                {{ form_row(form.recipients) }}
                {{ form_row(form.numNurses) }}
                {{ form_row(form.whatsappMessage) }}
            </div>

            {{ form_rest(form) }}

            <div class="flex items-center justify-end mt-10 pt-6 border-t border-gray-200">
                <a href="{{ path('app_services_list') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-colors duration-300">
                    Volver a la Lista
                </a>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 ml-4">
                    Guardar Cambios
                </button>
            </div>

            {{ form_end(form) }}
        </div>
    </div>

    <div id="asistencias" class="tab-content-panel hidden" data-service-form-target="tabContent">
        <div class="bg-white shadow-xl rounded-2xl p-8">
            <div class="flex justify-start items-center mb-6 space-x-4">
                {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_COORDINATOR') %}
                <div data-action="click->service-form#openModal">
                    <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center">
                        <i data-lucide="user-plus" class="mr-2 h-5 w-5"></i> A√±adir voluntarios
                    </button>
                </div>
                {% endif %}
                <button type="button" id="fichar-todos-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center">
                    <i data-lucide="check-square" class="mr-2 h-5 w-5"></i> Fichar todos
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h4 class="text-lg font-semibold mb-3 p-3 bg-green-100 text-green-800 rounded-lg flex justify-between items-center">
                        <span>Asisten</span>
                        <span class="bg-green-200 text-green-800 text-sm font-bold px-2 py-1 rounded-full">{{ service.assistanceConfirmations|filter(c => c.status == 'attending')|length }}</span>
                    </h4>
                    <ul class="list-group space-y-2">
                        {% for confirmation in service.assistanceConfirmations|filter(c => c.status == 'attending') %}
                            <li class="list-group-item bg-gray-50 p-3 rounded-lg shadow-sm">
                                {% set vs = fichajes[confirmation.volunteer.id] ?? null %}
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-bold {% if confirmation.isFichajeResponsible %}text-blue-600{% endif %}">
                                            {% if confirmation.isFichajeResponsible %}
                                                <i data-lucide="star" class="h-5 w-5 inline-block text-yellow-500 fill-current" title="Responsable de Fichaje"></i>
                                            {% endif %}
                                            {{ confirmation.volunteer.name }} {{ confirmation.volunteer.lastname }}
                                        </span>
                                        {% if vs %}
                                            {% set totalMinutes = vs.calculateTotalDuration() %}
                                            {% if totalMinutes > 0 %}
                                                {% set hours = (totalMinutes / 60)|round(0, 'floor') %}
                                                {% set minutes = totalMinutes % 60 %}
                                                <span class="ml-2 text-sm font-semibold text-gray-600 bg-gray-200 px-2 py-1 rounded-full" title="Total: {{ totalMinutes }} minutos">{{ hours }}h {{ minutes }}m</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        {% if vs %}
                                            {% set last_end_time = null %}
                                            {% for fichaje_item in vs.fichajes %}
                                                {% if fichaje_item.endTime is not null %}
                                                    {% if last_end_time is null or fichaje_item.endTime > last_end_time %}
                                                        {% set last_end_time = fichaje_item.endTime %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            <button type="button"
                                                    class="text-blue-600 hover:text-blue-800 p-1"
                                                    title="A√±adir fichaje manual"
                                                    data-action="click->service-form#openIndividualFichajeModal"
                                                    data-volunteer-service-id="{{ vs.id }}"
                                                    data-volunteer-name="{{ confirmation.volunteer.name }} {{ confirmation.volunteer.lastname }}"
                                                    data-last-clock-out="{{ last_end_time ? last_end_time|date('Y-m-d H:i:s') : '' }}">
                                                <i data-lucide="clock" class="h-5 w-5"></i>
                                            </button>
                                        {% endif %}
                                        <form method="post" action="{{ path('app_assistance_confirmation_toggle_responsible', {'id': confirmation.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('toggle-responsible' ~ confirmation.id) }}">
                                            <button type="submit"
                                                    class="p-1 {% if confirmation.isFichajeResponsible %}text-yellow-500 hover:text-yellow-600{% else %}text-gray-400 hover:text-blue-600{% endif %}"
                                                    title="{% if confirmation.isFichajeResponsible %}Quitar como responsable de fichaje{% else %}Asignar como responsable de fichaje{% endif %}">
                                                <i data-lucide="shield" class="h-5 w-5"></i>
                                            </button>
                                        </form>
                                        <form method="post" action="{{ path('app_assistance_confirmation_remove', {'id': confirmation.id}) }}" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar la confirmaci√≥n de asistencia de este voluntario? Esta acci√≥n no se puede deshacer.');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ confirmation.id) }}">
                                            <button type="submit" class="text-red-500 hover:text-red-700 p-1">
                                                <i data-lucide="trash-2" class="h-5 w-5"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                {% if vs and vs.fichajes|length > 0 %}
                                    <div class="mt-3 text-sm">
                                        <h5 class="font-semibold text-gray-700">Historial de Fichajes:</h5>
                                        <ul class="list-disc pl-5 mt-1 space-y-1 text-gray-600">
                                            {% for fichaje_item in vs.fichajes|sort((a, b) => a.startTime <=> b.startTime) %}
                                                <li class="flex justify-between items-center group">
                                                    <span>
                                                        {{ fichaje_item.startTime|date('d/m H:i') }} -
                                                        {% if fichaje_item.endTime %}
                                                            {{ fichaje_item.endTime|date('H:i') }}
                                                        {% else %}
                                                            <span class="font-semibold text-blue-600">Abierto</span>
                                                        {% endif %}
                                                        {% if fichaje_item.notes %}
                                                            <em class="text-gray-500 ml-2" title="{{ fichaje_item.notes }}">"{{ fichaje_item.notes|length > 30 ? fichaje_item.notes|slice(0, 30) ~ '...' : fichaje_item.notes }}"</em>
                                                        {% endif %}
                                                    </span>
                                                    <div class="hidden group-hover:flex items-center space-x-2">
                                                        <button type="button"
                                                                class="text-gray-500 hover:text-blue-600 p-1"
                                                                title="Editar Fichaje"
                                                                data-action="click->service-form#openEditFichajeModal"
                                                                data-fichaje-id="{{ fichaje_item.id }}"
                                                                data-start-time="{{ fichaje_item.startTime|date('Y-m-d\\TH:i') }}"
                                                                data-end-time="{{ fichaje_item.endTime ? fichaje_item.endTime|date('Y-m-d\\TH:i') : '' }}"
                                                                data-notes="{{ fichaje_item.notes }}">
                                                            <i data-lucide="pencil" class="h-4 w-4"></i>
                                                        </button>
                                                        <form method="post" action="{{ path('app_fichaje_delete', {'id': fichaje_item.id}) }}" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar este registro de fichaje?');" class="inline-block">
                                                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ fichaje_item.id) }}">
                                                            <button type="submit" class="text-gray-500 hover:text-red-600 p-1" title="Eliminar Fichaje">
                                                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% else %}
                                    <div class="mt-2 text-sm text-gray-500 italic">
                                        A√∫n no hay registros de fichaje.
                                    </div>
                                {% endif %}
                            </li>
                        {% else %}
                            <li class="list-group-item text-gray-500 italic">Nadie asiste todav√≠a.</li>
                        {% endfor %}
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold mb-3 p-3 bg-yellow-100 text-yellow-800 rounded-lg flex justify-between items-center">
                        <span>Reserva</span>
                        <span class="bg-yellow-200 text-yellow-800 text-sm font-bold px-2 py-1 rounded-full">{{ service.assistanceConfirmations|filter(c => c.status == 'reserved')|length }}</span>
                    </h4>
                    <ul class="list-group space-y-2">
                        {% for confirmation in service.assistanceConfirmations|filter(c => c.status == 'reserved') %}
                            <li class="list-group-item bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between items-center">
                                <span>
                                    {{ confirmation.volunteer.name }} {{ confirmation.volunteer.lastname }}
                                    <small class="text-gray-500">({{ confirmation.updatedAt|date('d/m/Y H:i') }})</small>
                                </span>
                                <form method="post" action="{{ path('app_assistance_confirmation_remove', {'id': confirmation.id}) }}" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar la confirmaci√≥n de asistencia de este voluntario? Esta acci√≥n no se puede deshacer.');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ confirmation.id) }}">
                                    <button type="submit" class="text-red-500 hover:text-red-700">
                                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                                    </button>
                                </form>
                            </li>
                        {% else %}
                            <li class="list-group-item text-gray-500 italic">No hay nadie en reserva.</li>
                        {% endfor %}
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold mb-3 p-3 bg-red-100 text-red-800 rounded-lg flex justify-between items-center">
                        <span>No Asisten</span>
                        <span class="bg-red-200 text-red-800 text-sm font-bold px-2 py-1 rounded-full">{{ service.assistanceConfirmations|filter(c => c.status == 'not_attending')|length }}</span>
                    </h4>
                    <ul class="list-group space-y-2">
                        {% for confirmation in service.assistanceConfirmations|filter(c => c.status == 'not_attending') %}
                            <li class="list-group-item bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between items-center">
                                <span>
                                    {{ confirmation.volunteer.name }} {{ confirmation.volunteer.lastname }}
                                    <small class="text-gray-500">({{ confirmation.updatedAt|date('d/m/Y H:i') }})</small>
                                </span>
                                <form method="post" action="{{ path('app_assistance_confirmation_remove', {'id': confirmation.id}) }}" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar la confirmaci√≥n de asistencia de este voluntario? Esta acci√≥n no se puede deshacer.');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ confirmation.id) }}">
                                    <button type="submit" class="text-red-500 hover:text-red-700">
                                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                                    </button>
                                </form>
                            </li>
                        {% else %}
                            <li class="list-group-item text-gray-500 italic">Nadie ha cancelado.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="vehiculos" class="tab-content-panel hidden" data-service-form-target="tabContent">
        <div class="bg-white shadow-xl rounded-2xl p-8">
            <div class="flex justify-start items-center mb-6 space-x-4">
                <button type="button" data-action="click->service-form#openVehicleModal" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center">
                    <i data-lucide="plus" class="mr-2 h-5 w-5"></i> A√±adir Veh√≠culo
                </button>
            </div>
            <div id="service-vehicles-list">
                <!-- Service vehicles will be listed here -->
                {% for sv in serviceVehicles %}
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg shadow-sm mb-2">
                        <div>
                            <span class="font-bold">{{ sv.vehicle.make }} {{ sv.vehicle.model }} ({{ sv.vehicle.licensePlate }})</span>
                            {% if sv.volunteer %}
                                <span class="ml-4">{{ sv.volunteer.name }} {{ sv.volunteer.lastname }} - <span class="font-semibold">{{ sv.role }}</span></span>
                            {% endif %}
                        </div>
                        <div class="flex items-center space-x-2">
                            <select data-action="change->service-form#assignVolunteer" data-service-vehicle-id="{{ sv.id }}">
                                <option value="">Asignar Voluntario</option>
                                {% for confirmation in service.assistanceConfirmations|filter(c => c.status == 'attending') %}
                                    <option value="{{ confirmation.volunteer.id }}" {% if sv.volunteer and sv.volunteer.id == confirmation.volunteer.id %}selected{% endif %}>{{ confirmation.volunteer.name }} {{ confirmation.volunteer.lastname }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" value="{{ sv.role }}" data-action="change->service-form#assignRole" data-service-vehicle-id="{{ sv.id }}" placeholder="Rol" class="p-1 border rounded">
                            <form method="post" action="{{ path('app_service_vehicle_remove', {'id': sv.id}) }}" onsubmit="return confirm('¬øEst√°s seguro de que quieres eliminar este veh√≠culo del servicio?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ sv.id) }}">
                                <button type="submit" class="text-red-500 hover:text-red-700 p-1">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic">No hay veh√≠culos asignados a este servicio.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50" data-service-form-target="modal">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-2xl font-bold text-gray-900">Agregar respuestas</h3>
                <button type="button" data-action="click->service-form#closeModal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="mb-4">
                <label for="attendance-status-select" class="block text-sm font-medium text-gray-700 mb-1">Respuesta <span class="text-red-500">*</span></label>
                <select data-service-form-target="attendanceStatusSelect" id="attendance-status-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                    <option value="" selected disabled>Selecciona...</option>
                    <option value="attends">Asiste</option>
                    <option value="not_attends">No asiste</option>
                </select>
            </div>

            <div class="flex justify-between items-center mb-4">
                <div>
                    <label for="items-per-page" class="text-sm font-medium text-gray-700 mr-2">Mostrar:</label>
                    <select id="items-per-page" data-service-form-target="itemsPerPageSelect" data-action="change->service-form#search" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                     <span class="text-sm text-gray-600 ml-2">registros</span>
                </div>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                    </span>
                    <input type="text" data-service-form-target="userSearchInput" data-action="keyup->service-form#search" placeholder="Buscar..." class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 pl-10">
                </div>
            </div>

            <div data-service-form-target="userList" class="space-y-1 mb-4 border rounded-lg p-2" style="min-height: 200px; max-height: 40vh; overflow-y: auto;">
                <!-- Volunteer list will be populated here -->
            </div>

            <div class="flex justify-between items-center mb-6">
                <div data-service-form-target="paginationSummary" class="text-sm text-gray-700">
                    <!-- Pagination summary will be populated here -->
                </div>
                <div data-service-form-target="paginationContainer" class="flex justify-center items-center">
                    <!-- Pagination controls will be populated here -->
                </div>
            </div>

            <div class="flex justify-end space-x-4 border-t pt-4">
                <button type="button" data-action="click->service-form#saveAttendance" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Aceptar</button>
            </div>
        </div>
    </div>

    {{ include('service/_fichar_modal.html.twig') }}
    {{ include('service/_individual_fichaje_modal.html.twig') }}

    <!-- Add Vehicle Modal -->
    <div class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50" data-service-form-target="vehicleModal">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-2xl font-bold text-gray-900">A√±adir Veh√≠culos al Servicio</h3>
                <button type="button" data-action="click->service-form#closeVehicleModal" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="relative mb-4">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                </span>
                <input type="text" data-service-form-target="vehicleSearchInput" data-action="keyup->service-form#searchVehicles" placeholder="Buscar por marca, modelo, matr√≠cula o alias..." class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 pl-10">
            </div>
            <div data-service-form-target="vehicleList" class="space-y-1 mb-4 border rounded-lg p-2" style="min-height: 200px; max-height: 40vh; overflow-y: auto;">
                <!-- Vehicle list will be populated here -->
            </div>
            <div class="flex justify-end space-x-4 border-t pt-4">
                <button type="button" data-action="click->service-form#saveVehicles" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">A√±adir Seleccionados</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('turbo:load', () => {
            const ficharTodosBtn = document.getElementById('fichar-todos-btn');
            const ficharModal = document.getElementById('fichar-modal');

            if (ficharTodosBtn) {
                ficharTodosBtn.addEventListener('click', () => {
                    // Pre-fill form with service dates and times
                    const startDate = new Date("{{ service.startDate|date('Y-m-d H:i:s') }}");
                    const endDate = new Date("{{ service.endDate|date('Y-m-d H:i:s') }}");

                    // Format to YYYY-MM-DD
                    const startDateStr = startDate.toISOString().split('T')[0];
                    const endDateStr = endDate.toISOString().split('T')[0];

                    // Format to HH:MM
                    const startTimeStr = startDate.toTimeString().substring(0, 5);
                    const endTimeStr = endDate.toTimeString().substring(0, 5);

                    document.getElementById('start-date').value = startDateStr;
                    document.getElementById('start-time').value = startTimeStr;
                    document.getElementById('end-date').value = endDateStr;
                    document.getElementById('end-time').value = endTimeStr;

                    ficharModal.classList.remove('hidden');
                });
            }
        });

        function handleFichaje(button) {
            const notes = prompt("A√±adir una nota (opcional):");
            if (notes !== null) { // prompt returns null if user clicks Cancel
                const form = button.closest('form');

                // Remove existing notes input if it exists
                const existingInput = form.querySelector('input[name="notes"]');
                if (existingInput) {
                    existingInput.remove();
                }

                if (notes) { // Only add input if notes were provided
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'notes';
                    hiddenInput.value = notes;
                    form.appendChild(hiddenInput);
                }

                return true; // Allow form to submit
            }
            return false; // Prevent form submission if user cancels
        }
    </script>
{% endblock %}
