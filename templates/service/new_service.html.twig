{% extends 'layout/app.html.twig' %}

{% block title %}Crear Nuevo Servicio{% endblock %}
{% block page_title %}Crear Nuevo Servicio{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .mini-input { width: 60px !important; text-align: right; }
        .tox-tinymce { border-radius: 1.5rem !important; border: 1px solid #E2E8F0 !important; }
        .tab-content > .tab-pane:not(.active) { display: none !important; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid #3b82f6 !important; color: #3b82f6 !important; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block content %}
<div class="w-full px-8 py-8 bg-slate-100 min-h-full" data-controller="service-form">
    {{ form_start(form, {
        'attr': {
            'id': 'service-form',
            'data-service-form-target': 'form'
        }
    }) }}

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-6 border-0 space-x-4" id="serviceTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active border-0 bg-transparent font-bold py-2 transition-all" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                1. Datos Generales
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link border-0 bg-transparent font-bold py-2 transition-all" id="resources-tab" data-bs-toggle="tab" data-bs-target="#resources" type="button" role="tab">
                2. Recursos y Dotación
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- PESTAÑA 1: DATOS GENERALES -->
        <div class="tab-pane show active" id="general" role="tabpanel">
            <div class="card card-shadow border-0 rounded-3xl overflow-hidden mb-6">
                <div class="card-body p-8">
                    <div class="row g-4 mb-6">
                        <div class="col-md-8">
                            <label class="form-label text-xs font-bold text-slate-500 uppercase tracking-wider" for="{{ form.title.vars.id }}">Título del Servicio</label>
                            {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-xs font-bold text-slate-500 uppercase tracking-wider" for="{{ form.numeration.vars.id }}">Nº de Registro</label>
                            {{ form_widget(form.numeration, {'attr': {'class': 'form-control'}}) }}
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="form-label text-xs font-bold text-slate-500 uppercase tracking-wider" for="{{ form.locality.vars.id }}">Ubicación</label>
                        {{ form_widget(form.locality, {'attr': {'class': 'form-control'}}) }}
                    </div>

                    <!-- Jerarquía de 3 Niveles -->
                    <div class="row g-4 mb-6">
                        <div class="col-md-4">
                            <label class="form-label text-xs font-bold text-slate-500 uppercase tracking-wider" for="{{ form.type_selector.vars.id }}">Tipo</label>
                            {{ form_widget(form.type_selector, {'attr': {'class': 'form-select'}}) }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-xs font-bold text-slate-500 uppercase tracking-wider" for="{{ form.category_selector.vars.id }}">Categoría</label>
                            {{ form_widget(form.category_selector, {'attr': {'class': 'form-select'}}) }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-xs font-bold text-slate-500 uppercase tracking-wider" for="{{ form.subcategory.vars.id }}">Subcategoría</label>
                            {{ form_widget(form.subcategory, {'attr': {'class': 'form-select'}}) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cronología -->
            <div class="card card-shadow border-0 rounded-3xl overflow-hidden mb-6">
                <div class="card-body p-8">
                    <h6 class="text-slate-400 text-[10px] uppercase tracking-[0.2em] font-black mb-6">Cronología</h6>
                    <div class="row g-4">
                        <div class="col">
                            <label class="form-label text-xs font-bold text-slate-500" for="{{ form.startDate.vars.id }}">Inicio</label>
                            {{ form_widget(form.startDate, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="col">
                            <label class="form-label text-xs font-bold text-slate-500" for="{{ form.endDate.vars.id }}">Fin</label>
                            {{ form_widget(form.endDate, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="col">
                            <label class="form-label text-xs font-bold text-slate-500" for="{{ form.timeAtBase.vars.id }}">Base</label>
                            {{ form_widget(form.timeAtBase, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="col">
                            <label class="form-label text-xs font-bold text-slate-500" for="{{ form.departureTime.vars.id }}">Salida</label>
                            {{ form_widget(form.departureTime, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="col">
                            <label class="form-label text-xs font-bold text-slate-500" for="{{ form.registrationLimitDate.vars.id }}">Límite Inscrip.</label>
                            {{ form_widget(form.registrationLimitDate, {'attr': {'class': 'form-control'}}) }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Definición Operativa -->
            <div class="card card-shadow border-0 rounded-3xl overflow-hidden mb-6">
                <div class="card-body p-8">
                    <h6 class="text-slate-400 text-[10px] uppercase tracking-[0.2em] font-black mb-6">Definición Operativa</h6>
                    <div class="mb-4">
                        <label class="form-label text-sm font-bold text-slate-700" for="{{ form.tasks.vars.id }}">Tareas (Igual que Word)</label>
                        {{ form_widget(form.tasks, {'attr': {'class': 'form-control border-slate-200'}}) }}
                    </div>
                    <div>
                        <label class="form-label text-sm font-bold text-slate-700" for="{{ form.description.vars.id }}">Descripción (Igual que Word)</label>
                        {{ form_widget(form.description, {'attr': {'class': 'form-control'}}) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTAÑA 2: RECURSOS Y DOTACIÓN -->
        <div class="tab-pane" id="resources" role="tabpanel">
            <!-- Bloque Superior: Material Nuevo -->
            <div class="card card-shadow border-0 rounded-3xl overflow-hidden mb-6">
                <div class="card-body p-8">
                    <h6 class="text-slate-400 text-[10px] uppercase tracking-[0.2em] font-black mb-8">Material Nuevo</h6>
                    <div class="row g-4">
                        <!-- Sanitario -->
                        <div class="col-md-4 border-end">
                            <div class="flex justify-between items-center mb-4 pe-4">
                                <h6 class="text-xs font-black text-slate-800 uppercase">Sanitario</h6>
                                <button type="button" class="btn btn-sm btn-primary rounded-circle" data-action="click->service-form#addMaterial" data-category="sanitario">+</button>
                            </div>
                            <div id="material-list-sanitario" class="space-y-3 pe-4">
                                <!-- Dynamic materials here -->
                            </div>
                        </div>
                        <!-- Comunicaciones -->
                        <div class="col-md-4 border-end px-4">
                            <div class="flex justify-between items-center mb-4">
                                <h6 class="text-xs font-black text-slate-800 uppercase">Comunicaciones</h6>
                                <button type="button" class="btn btn-sm btn-primary rounded-circle" data-action="click->service-form#addMaterial" data-category="comunicaciones">+</button>
                            </div>
                            <div id="material-list-comunicaciones" class="space-y-3">
                                <!-- Dynamic materials here -->
                            </div>
                        </div>
                        <!-- Logística -->
                        <div class="col-md-4 ps-4">
                            <div class="flex justify-between items-center mb-4">
                                <h6 class="text-xs font-black text-slate-800 uppercase">Logística</h6>
                                <button type="button" class="btn btn-sm btn-primary rounded-circle" data-action="click->service-form#addMaterial" data-category="logistica">+</button>
                            </div>
                            <div id="material-list-logistica" class="space-y-3">
                                <!-- Dynamic materials here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bloque Inferior: Dotación Antigua -->
            <div class="card card-shadow border-0 rounded-3xl overflow-hidden mb-6">
                <div class="card-body p-8">
                    <h6 class="text-slate-400 text-[10px] uppercase tracking-[0.2em] font-black mb-8">Dotación Antigua</h6>
                    <div class="row g-4">
                        <!-- Vehículos -->
                        <div class="col-md-6 border-end pe-4">
                            <h6 class="text-xs font-black text-slate-800 uppercase mb-4">Vehículos</h6>
                            {{ form_widget(form.vehicles, {'attr': {'class': 'form-select', 'size': 5}}) }}
                        </div>
                        <!-- Personal -->
                        <div class="col-md-6 ps-4">
                            <h6 class="text-xs font-black text-slate-800 uppercase mb-4">Personal</h6>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex justify-between items-center">
                                    <label class="text-xs font-bold text-slate-500" for="{{ form.numTes.vars.id }}">TES</label>
                                    {{ form_widget(form.numTes, {'attr': {'class': 'form-control form-control-sm mini-input'}}) }}
                                </div>
                                <div class="flex justify-between items-center">
                                    <label class="text-xs font-bold text-slate-500" for="{{ form.numTts.vars.id }}">TTS</label>
                                    {{ form_widget(form.numTts, {'attr': {'class': 'form-control form-control-sm mini-input'}}) }}
                                </div>
                                <div class="flex justify-between items-center">
                                    <label class="text-xs font-bold text-slate-500" for="{{ form.numDue.vars.id }}">DUE</label>
                                    {{ form_widget(form.numDue, {'attr': {'class': 'form-control form-control-sm mini-input'}}) }}
                                </div>
                                <div class="flex justify-between items-center">
                                    <label class="text-xs font-bold text-slate-500" for="{{ form.numDoctors.vars.id }}">Médicos</label>
                                    {{ form_widget(form.numDoctors, {'attr': {'class': 'form-control form-control-sm mini-input'}}) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Collection Prototype -->
    <div class="hidden" data-service-form-target="prototype" data-prototype="{{ form_widget(form.serviceMaterials.vars.prototype)|e('html_attr') }}"></div>

    <!-- Actions -->
    <div class="flex justify-end gap-3 pt-6 border-t mt-8">
        <a href="{{ path('app_services_list') }}" class="btn btn-outline-secondary px-8 py-3 rounded-xl font-bold">Cancelar</a>
        <button type="submit" class="btn btn-primary px-8 py-3 rounded-xl font-bold bg-blue-700">Guardar Servicio</button>
    </div>

    {{ form_end(form) }}
</div>

<!-- Modal for New Material -->
<div id="materialModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Nuevo Material</h3>
        <input type="hidden" id="modal-material-category">
        <div class="mb-4">
            <label for="new-material-name" class="block text-sm font-bold text-slate-700 mb-2">Nombre del Material</label>
            <input type="text" id="new-material-name" class="form-control" placeholder="Ej: Respirador">
        </div>
        <div class="flex justify-end gap-3">
            <button type="button" class="btn btn-light" data-action="click->service-form#closeMaterialModal">Cancelar</button>
            <button type="button" class="btn btn-primary" data-action="click->service-form#saveNewMaterial">Añadir al Maestro</button>
        </div>
    </div>
</div>

{% endblock %}
