{% extends 'layout/app.html.twig' %}

{% block page_title %}Gesti√≥n Voluntarios{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <!-- Welcome section -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-6 text-white">
        <h2 class="text-2xl font-bold mb-2">¬°Bienvenido al Sistema de Gesti√≥n!</h2>
        <p class="text-blue-100">
            Gestiona voluntarios, recursos y servicios de manera eficiente desde un solo lugar.
        </p>
    </div>

    <!-- Stats cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Voluntarios Activos</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">123</p> {# Replace with dynamic data #}
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-green-600">+12</span>
                        <span class="text-sm text-gray-500 ml-1">este mes</span>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Servicios del Mes</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">89</p>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-green-600">+5</span>
                        <span class="text-sm text-gray-500 ml-1">este mes</span>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <i data-lucide="calendar" class="w-6 h-6 text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Veh√≠culos Disponibles</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">15</p>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-red-600">-2</span>
                        <span class="text-sm text-gray-500 ml-1">este mes</span>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <i data-lucide="car" class="w-6 h-6 text-purple-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Alertas Pendientes</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">3</p>
                    <div class="flex items-center mt-2">
                        <span class="text-sm font-medium text-gray-600">0</span>
                        <span class="text-sm text-gray-500 ml-1">este mes</span>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent activities -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Actividad Reciente</h3>
            <div class="space-y-4">
                <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 mt-2"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Nuevo voluntario registrado</p>
                        <p class="text-sm text-gray-600">Mar√≠a Garc√≠a</p>
                        <p class="text-xs text-gray-500 mt-1">Hace 2 horas</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <div class="w-2 h-2 rounded-full bg-blue-500 mt-2"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Servicio completado</p>
                        <p class="text-sm text-gray-600">Equipo Alpha</p>
                        <p class="text-xs text-gray-500 mt-1">Hace 4 horas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming events -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pr√≥ximos Eventos</h3>
            <div class="space-y-4">
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900">Formaci√≥n en Primeros Auxilios</h4>
                    <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                        <span>üìÖ 15 Mar 2024</span>
                        <span>üïê 10:00</span>
                        <span>üë• 25 participantes</span>
                    </div>
                </div>
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="font-medium text-gray-900">Simulacro de Emergencia</h4>
                    <div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
                        <span>üìÖ 18 Mar 2024</span>
                        <span>üïê 09:00</span>
                        <span>üë• 40 participantes</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick actions -->
    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Acciones R√°pidas</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="{{ path('app_volunteer_new') }}" class="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                <span class="font-medium">A√±adir Voluntario</span>
            </a>
            <a href="{{ path('app_service_new') }}" class="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <i data-lucide="calendar" class="w-5 h-5 text-green-600"></i>
                <span class="font-medium">Programar Servicio</span>
            </a>
            <button class="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <i data-lucide="trending-up" class="w-5 h-5 text-purple-600"></i>
                <span class="font-medium">Ver Estad√≠sticas</span>
            </button>
            <button id="show-volunteers-btn" data-url="{{ path('app_volunteer_all') }}" class="flex items-center gap-3 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                <i data-lucide="list" class="w-5 h-5 text-yellow-600"></i>
                <span class="font-medium">Mostrar Voluntarios</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const showModalBtn = document.getElementById('show-volunteers-btn');
        let debounceTimer;

        // Function to fetch and render volunteers
        async function fetchAndRenderVolunteers(searchTerm = '', limit = 10) {
            const baseUrl = showModalBtn.dataset.url;
            const url = new URL(baseUrl, window.location.origin);
            url.searchParams.append('search', searchTerm);
            url.searchParams.append('limit', limit);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const volunteers = await response.json();

                const list = document.getElementById('volunteer-list-container');
                if (!list) return;

                list.innerHTML = ''; // Clear current list
                if (volunteers.length > 0) {
                    volunteers.forEach(v => {
                        const listItem = document.createElement('li');
                        listItem.className = 'p-2 border-b border-gray-200 flex items-center';

                        const img = document.createElement('img');
                        img.src = v.profilePicture ? `/uploads/profile_pictures/${v.profilePicture}` : 'https://via.placeholder.com/40';
                        img.alt = v.name;
                        img.className = 'w-10 h-10 rounded-full mr-3 object-cover';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `volunteer-${v.id}`;
                        checkbox.value = v.id;
                        checkbox.className = 'mr-3 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';

                        const label = document.createElement('label');
                        label.htmlFor = `volunteer-${v.id}`;
                        label.textContent = v.name;

                        listItem.appendChild(img);
                        listItem.appendChild(checkbox);
                        listItem.appendChild(label);
                        list.appendChild(listItem);
                    });
                } else {
                    list.innerHTML = '<p>No se encontraron voluntarios.</p>';
                }
            } catch (error) {
                console.error('Error fetching volunteers:', error);
                const list = document.getElementById('volunteer-list-container');
                if(list) list.innerHTML = '<p>Error al cargar los voluntarios.</p>';
            }
        }

        // Function to create the modal structure
        function createModal() {
            const existingModal = document.getElementById('volunteer-list-modal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'volunteer-list-modal';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center';
            modal.style.zIndex = '1050';

            modal.innerHTML = `
                <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h3 class="text-lg font-medium text-gray-900">Lista de Voluntarios</h3>
                        <button id="close-volunteer-modal-btn" type="button" class="text-black close-modal text-2xl leading-none hover:text-gray-700">&times;</button>
                    </div>
                    <div class="py-3 flex justify-between items-center">
                        <input type="text" id="volunteer-search-input" placeholder="Buscar por nombre..." class="w-full md:w-1/2 p-2 border border-gray-300 rounded-md">
                        <select id="volunteer-limit-select" class="p-2 border border-gray-300 rounded-md">
                            <option value="10">10 por p√°gina</option>
                            <option value="25" selected>25 por p√°gina</option>
                            <option value="50">50 por p√°gina</option>
                            <option value="100">100 por p√°gina</option>
                        </select>
                    </div>
                    <ul id="volunteer-list-container" class="space-y-2 max-h-80 overflow-y-auto py-3">
                        <!-- Volunteer list will be rendered here -->
                    </ul>
                </div>
            `;

            document.body.appendChild(modal);

            // Add event listeners for the new controls
            const searchInput = document.getElementById('volunteer-search-input');
            const limitSelect = document.getElementById('volunteer-limit-select');
            const closeButton = document.getElementById('close-volunteer-modal-btn');

            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    fetchAndRenderVolunteers(searchInput.value, limitSelect.value);
                }, 300);
            });

            limitSelect.addEventListener('change', () => {
                fetchAndRenderVolunteers(searchInput.value, limitSelect.value);
            });

            const closeModal = () => modal.remove();
            closeButton.onclick = closeModal;
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
        }

        // Main event listener for the button
        if (showModalBtn) {
            showModalBtn.addEventListener('click', () => {
                createModal();
                // Initial fetch
                const searchInput = document.getElementById('volunteer-search-input');
                const limitSelect = document.getElementById('volunteer-limit-select');
                fetchAndRenderVolunteers(searchInput.value, limitSelect.value);
            });
        }
    });
</script>
{% endblock %}
