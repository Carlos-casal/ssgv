{% extends 'layout/app.html.twig' %}

{% block title %}Gestión de Materiales{% endblock %}

{% block page_title %}Inventario de Materiales{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0 text-gray-800">Listado General {{ current_category ? '- ' ~ current_category : '' }}</h2>
        <div class="d-flex gap-2">
            <form class="d-flex align-items-center gap-2 me-3" method="get">
                {% if current_category %}
                    <input type="hidden" name="category" value="{{ current_category }}">
                {% endif %}

                {% if current_category == 'Sanitario' %}
                    <select name="subFamily" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                        <option value="">Todas las familias...</option>
                        {% for f in ['Analgésicos', 'Curas', 'Inmovilización', 'Medicación', 'Diagnóstico', 'Protección', 'Oxigenoterapia', 'Vía Aérea', 'Varios'] %}
                            <option value="{{ f }}" {{ current_subfamily == f ? 'selected' : '' }}>{{ f }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <select name="size" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                        <option value="">Filtrar por talla...</option>
                        <optgroup label="Letras">
                            {% for s in ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL'] %}
                                <option value="{{ s }}" {{ current_size == s ? 'selected' : '' }}>Talla {{ s }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Números">
                            {% for s in range(36, 56, 2) %}
                                <option value="{{ s }}" {{ current_size == s ? 'selected' : '' }}>Talla {{ s }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                {% endif %}

                {% if current_size or current_subfamily %}
                    <a href="{{ path('app_material_index', {category: current_category}) }}" class="btn btn-sm btn-outline-secondary">Limpiar</a>
                {% endif %}
            </form>
            <button type="button" class="btn btn-success mr-2" data-toggle="modal" data-target="#importModal">
                <i class="fas fa-file-excel mr-2"></i>Carga Masiva Excel
            </button>
            <a href="{{ path('app_material_new', {category: current_category}) }}" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i> Nuevo Material
            </a>
        </div>
    </div>

    {% include 'material/_import_modal.html.twig' %}

    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead class="bg-light text-primary">
                        <tr>
                            <th>Imagen</th>
                            <th>Nombre</th>
                            {% if current_category == 'Sanitario' %}
                                <th>Subfamilia</th>
                                <th>Caducidad</th>
                            {% else %}
                                <th>Categoría</th>
                            {% endif %}
                            <th>Naturaleza</th>
                            <th>Stock / Unidades</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for material in materials %}
                        {% set status = material.expirationStatus %}
                        <tr class="{{ current_category == 'Sanitario' and status == 'red' ? 'table-danger' : '' }}">
                            <td>
                                {% if material.imagePath %}
                                    <img src="{{ asset('uploads/material_images/' ~ material.imagePath) }}" 
                                         alt="{{ material.name }}" 
                                         class="img-thumbnail" 
                                         style="width: 50px; height: 50px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-light d-flex align-items-center justify-content-center" 
                                         style="width: 50px; height: 50px; border-radius: 4px;">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td class="font-weight-bold">{{ material.name }}</td>
                            {% if current_category == 'Sanitario' %}
                                <td><span class="badge bg-light text-primary">{{ material.subFamily|default('N/A') }}</span></td>
                                <td>
                                    {% if material.expirationDate %}
                                        <span class="badge {{ status == 'red' ? 'bg-danger' : (status in ['orange', 'yellow'] ? 'bg-warning text-dark' : 'bg-success') }}">
                                            {{ material.expirationDate|date('d/m/Y') }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted small">N/A</span>
                                    {% endif %}
                                </td>
                            {% else %}
                                <td>{{ material.category }}</td>
                            {% endif %}
                            <td>
                                <span class="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-wider {{ material.nature == 'CONSUMIBLE' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-700' }}">
                                    {{ material.nature }}
                                </span>
                            </td>
                            <td>
                                {% if material.nature == 'CONSUMIBLE' %}
                                    <span class="font-mono font-bold">{{ material.stock }}</span>
                                {% else %}
                                    <span class="font-bold">{{ material.units|length }}</span> <span class="text-xs text-slate-400">unidades</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if material.isLowStock %}
                                    <span class="px-3 py-1 rounded-lg bg-red-50 text-red-600 text-xs font-black uppercase flex items-center w-fit">
                                        <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i> Reposición
                                    </span>
                                {% else %}
                                    <span class="px-3 py-1 rounded-lg bg-green-50 text-green-600 text-xs font-black uppercase flex items-center w-fit">
                                        <i data-lucide="check" class="w-3 h-3 mr-1"></i> OK
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ path('app_material_show', {'id': material.id}) }}" class="btn btn-sm btn-outline-primary" title="Ver Detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ path('app_material_edit', {'id': material.id}) }}" class="btn btn-sm btn-outline-secondary" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">No se encontraron materiales.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
