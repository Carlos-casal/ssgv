{% extends 'layout/app.html.twig' %}

{% block title %}Detalle de Material{% endblock %}

{% block page_title %}{{ material.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        {% if material.imagePath %}
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Imagen del Material</h6>
                </div>
                <div class="card-body text-center">
                    <img src="{{ asset('uploads/material_images/' ~ material.imagePath) }}" 
                         alt="{{ material.name }}" 
                         class="img-fluid rounded">
                </div>
            </div>
        </div>
        {% endif %}

        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Información General</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ material.category }}</div>
                            <div class="mt-2">
                                <span class="badge {{ material.nature == 'CONSUMIBLE' ? 'badge-info' : 'badge-dark' }}">
                                    {{ material.nature }}
                                </span>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-info-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if material.nature == 'CONSUMIBLE' %}
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card {{ material.isLowStock ? 'border-left-danger' : 'border-left-success' }} shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold {{ material.isLowStock ? 'text-danger' : 'text-success' }} text-uppercase mb-1">Stock Actual</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ material.stock }}</div>
                            <div class="text-xs text-muted">Mínimo: {{ material.safetyStock }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-2x text-gray-300"></i>
                        </div>
                    </div>
                    {% if material.isLowStock %}
                        <div class="mt-2 text-danger font-weight-bold small">
                            <i class="fas fa-exclamation-triangle"></i> Reposición Necesaria
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Trazabilidad y Finanzas</div>
                    <div class="mb-2">
                        <span class="small text-muted">Lote:</span>
                        <span class="font-weight-bold">{{ material.batch|default('N/A') }}</span>
                    </div>
                    <div class="mb-2">
                        <span class="small text-muted">Caducidad:</span>
                        {% set status = material.expirationStatus %}
                        <span class="badge badge-{{
                            status == 'green' ? 'success' :
                            (status == 'yellow' ? 'warning' :
                            (status == 'red' ? 'danger' : 'secondary'))
                        }}">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            {{ material.expirationDate ? material.expirationDate|date('d/m/Y') : 'Sin fecha' }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="small text-muted">Proveedor:</span>
                        <span class="small">{{ material.supplier|default('Desconocido') }}</span>
                    </div>
                    <div>
                        <span class="small text-muted">Valor Unitario:</span>
                        <span class="font-weight-bold text-gray-800">{{ material.unitPrice|number_format(2, ',', '.') }}€</span>
                        <span class="text-xs text-muted">(IVA {{ material.iva }}%)</span>
                    </div>
                </div>
            </div>
        </div>

        {% if material.barcode or material.description %}
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    {% if material.barcode %}
                    <div class="mb-3">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            <i class="fas fa-barcode mr-1"></i>Código de Barras
                        </div>
                        <div class="h6 mb-0 font-weight-bold text-gray-800">{{ material.barcode }}</div>
                    </div>
                    {% endif %}
                    {% if material.description %}
                    <div>
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            <i class="fas fa-align-left mr-1"></i>Descripción
                        </div>
                        <div class="small text-gray-700">{{ material.description|nl2br }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% if material.sizingType %}
    <div class="card shadow mb-4" data-controller="uniformity-grid">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Gestión de Stock por Tallas</h6>
            <span class="badge badge-info">Tallaje: {{
                material.sizingType == 'LETTER' ? 'Textil (Letras)' :
                (material.sizingType == 'NUMBER_CLOTHING' ? 'Ropa (Números)' : 'Calzado (Números)')
            }}</span>
        </div>
        <div class="card-body">
            {% set sizes = [] %}
            {% if material.sizingType == 'LETTER' %}
                {% set sizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '3XL'] %}
            {% elseif material.sizingType == 'NUMBER_CLOTHING' %}
                {% set sizes = range(32, 60, 2) %}
            {% elseif material.sizingType == 'NUMBER_SHOES' %}
                {% set sizes = range(35, 48) %}
            {% endif %}

            {# Collect manual/extra sizes that have stock #}
            {% set extra_sizes = [] %}
            {% for s in material.stocks %}
                {% if s.size not in sizes and s.quantity > 0 %}
                    {% set extra_sizes = extra_sizes|merge([s.size]) %}
                {% endif %}
            {% endfor %}

            <form action="{{ path('app_material_stock_adjust', {id: material.id}) }}" method="post">
                <input type="hidden" name="reason" value="Entrada de stock (Matriz)">

                <div class="table-responsive">
                    <table class="table table-sm table-bordered text-center align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="text-start ps-3">Talla</th>
                                {% for size in sizes %}
                                    <th width="60">{{ size }}</th>
                                {% endfor %}
                                {% for size in extra_sizes %}
                                    <th width="60" class="table-info">{{ size }}*</th>
                                {% endfor %}
                                <th width="120">Manual</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-start ps-3 font-weight-bold">Existencias</td>
                                {% for size in sizes %}
                                    {% set stock_item = null %}
                                    {% for s in material.stocks %}{% if s.size == size %}{% set stock_item = s %}{% endif %}{% endfor %}
                                    <td class="{{ stock_item and stock_item.quantity <= 0 ? 'bg-red-50' : '' }}">
                                        <div class="font-bold {{ stock_item and stock_item.quantity <= 0 ? 'text-danger' : 'text-slate-700' }}">
                                            {{ stock_item ? stock_item.quantity : 0 }}
                                        </div>
                                    </td>
                                {% endfor %}
                                {% for size in extra_sizes %}
                                    {% set stock_item = null %}
                                    {% for s in material.stocks %}{% if s.size == size %}{% set stock_item = s %}{% endif %}{% endfor %}
                                    <td class="table-info font-bold text-slate-700">
                                        {{ stock_item ? stock_item.quantity : 0 }}
                                    </td>
                                {% endfor %}
                                <td class="bg-light text-muted small">Nuevas...</td>
                            </tr>
                            <tr>
                                <td class="text-start ps-3 font-bold text-primary">Añadir Stock</td>
                                {% for size in sizes %}
                                    <td>
                                        <input type="number" name="adjustments[{{ size }}]" class="form-control form-control-sm text-center border-primary-subtle" value="0" min="0">
                                    </td>
                                {% endfor %}
                                {% for size in extra_sizes %}
                                    <td>
                                        <input type="number" name="adjustments[{{ size }}]" class="form-control form-control-sm text-center border-info-subtle" value="0" min="0">
                                    </td>
                                {% endfor %}
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" name="custom_size" class="form-control" placeholder="Talla">
                                        <input type="number" name="custom_qty" class="form-control w-25" value="0">
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3 flex justify-end gap-2">
                    <div class="input-group w-auto">
                        <span class="input-group-text bg-white"><i data-lucide="info" class="w-4 h-4 mr-2"></i> Motivo</span>
                        <input type="text" name="reason" class="form-control" placeholder="Ej: Reposición stock" value="Reposición de stock">
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="fas fa-save mr-2"></i> Guardar Cantidades
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if material.nature == 'EQUIPO_TECNICO' %}
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Unidades Individuales (Activos)</h6>
            <div class="btn-group">
                <a href="{{ path('app_material_unit_new', {'id': material.id}) }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plus"></i> Añadir Una
                </a>
                <a href="{{ path('app_material_unit_bulk', {'id': material.id}) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-th-list"></i> Alta por Lote
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="bg-light">
                        <tr>
                            <th>Nº Colectiva</th>
                            <th>Nº Serie / ID</th>
                            <th>Último Uso</th>
                            <th>Mantenimiento</th>
                            <th>Estado Accesorios</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for unit in material.units %}
                        <tr class="{{ unit.isInMaintenance ? 'table-warning' : '' }}">
                            <td><strong>{{ unit.collectiveNumber|default('-') }}</strong></td>
                            <td>{{ unit.serialNumber }}</td>
                            <td>{{ unit.lastUsedAt ? unit.lastUsedAt|date('d/m/Y H:i') : 'Nunca usado' }}</td>
                            <td>
                                {% if unit.isInMaintenance %}
                                    <span class="badge badge-warning">En Mantenimiento</span>
                                {% else %}
                                    <span class="badge badge-success">Operativo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="small">
                                    <span class="badge {{ unit.pttStatus == 'OK' ? 'badge-light' : 'badge-danger' }}">PTT: {{ unit.pttStatus }}</span>
                                    <span class="badge {{ unit.coverStatus == 'OK' ? 'badge-light' : 'badge-warning' }}">Funda: {{ unit.coverStatus }}</span>
                                    <span class="badge {{ unit.batteryStatus in ['100%', '75%', 'OK'] ? 'badge-light' : 'badge-danger' }}">Bat: {{ unit.batteryStatus }}</span>
                                </div>
                            </td>
                            <td>
                                <a href="{{ path('app_material_unit_edit', {'id': unit.id}) }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">No hay unidades registradas.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Historial de Movimientos</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Cantidad</th>
                            <th>Talla</th>
                            <th>Motivo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set movements = [] %}
                        {# This is a bit inefficient in Twig, ideally passed from controller #}
                        {# For now I'll just assume movements are accessible or I'll update controller #}
                        {% for movement in material_movements|default([]) %}
                            <tr>
                                <td>{{ movement.createdAt|date('d/m/Y H:i') }}</td>
                                <td>{{ movement.user ? movement.user.email : 'Sistema' }}</td>
                                <td>
                                    <span class="badge {{ movement.quantity > 0 ? 'badge-success' : 'badge-danger' }}">
                                        {{ movement.quantity > 0 ? '+' : '' }}{{ movement.quantity }}
                                    </span>
                                </td>
                                <td>{{ movement.size|default('-') }}</td>
                                <td>{{ movement.reason }}</td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No hay movimientos registrados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-4 d-flex gap-2">
        <a href="{{ path('app_material_transfer', {id: material.id}) }}" class="btn btn-primary">
            <i class="fas fa-exchange-alt mr-2"></i> Registrar Movimiento / Transferencia
        </a>
        <a href="{{ path('app_material_index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i> Volver al Listado
        </a>
    </div>
</div>
{% endblock %}
